services:
  neo4j:
    image: neo4j:5.18
    environment:
      NEO4J_AUTH: "neo4j/ResumeBuilder"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "cypher-shell -a bolt://localhost:7687 -u neo4j -p ResumeBuilder \"RETURN 1\" | grep -q 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 20s
    volumes:
      - neo4j_data:/data

  app:
    build: .
    environment:
      NEO4J_URI: "bolt://neo4j:7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "ResumeBuilder"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      OPENAI_ORGANIZATION: "${OPENAI_ORGANIZATION:-}"
      OPENAI_ORG_ID: "${OPENAI_ORG_ID:-}"
      OPENAI_PROJECT: "${OPENAI_PROJECT:-}"
      GEMINI_API_KEY: "${GEMINI_API_KEY:-}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY:-}"
      LLM_MODEL: "${LLM_MODEL:-}"
      OPENAI_MODEL: "${OPENAI_MODEL:-}"
    command: ["reflex", "run", "--frontend-port", "3000", "--backend-port", "8000"]
    ports:
      - "3001:3000"
      - "8001:8000"
    depends_on:
      neo4j:
        condition: service_healthy

  maxcov:
    build: .
    environment:
      NEO4J_URI: "bolt://neo4j:7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "ResumeBuilder"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      OPENAI_ORGANIZATION: "${OPENAI_ORGANIZATION:-}"
      OPENAI_ORG_ID: "${OPENAI_ORG_ID:-}"
      OPENAI_PROJECT: "${OPENAI_PROJECT:-}"
      GEMINI_API_KEY: "${GEMINI_API_KEY:-}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY:-}"
      LLM_MODEL: "${LLM_MODEL:-}"
      OPENAI_MODEL: "${OPENAI_MODEL:-}"
    volumes:
      - ./maxcov_logs:/var/log/maxcov
    depends_on:
      neo4j:
        condition: service_healthy

  ui-tests:
    build:
      context: .
      dockerfile: Dockerfile.ui
    environment:
      NEO4J_URI: "bolt://neo4j:7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "ResumeBuilder"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      OPENAI_ORGANIZATION: "${OPENAI_ORGANIZATION:-}"
      OPENAI_ORG_ID: "${OPENAI_ORG_ID:-}"
      OPENAI_PROJECT: "${OPENAI_PROJECT:-}"
      GEMINI_API_KEY: "${GEMINI_API_KEY:-}"
      GOOGLE_API_KEY: "${GOOGLE_API_KEY:-}"
      LLM_MODEL: "${LLM_MODEL:-}"
      OPENAI_MODEL: "${OPENAI_MODEL:-}"
    volumes:
      - ./maxcov_logs:/var/log/maxcov
    depends_on:
      neo4j:
        condition: service_healthy

volumes:
  neo4j_data:
